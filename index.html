<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Nacional de Energía de México - Visualización Sankey</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --primary-color: #00529B;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1rem;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .control-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            text-transform: uppercase;
        }

        .btn:hover {
            background-color: #003d7a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #chart-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #sankey {
            width: 100%;
            height: 70vh;
            /* Altura flexible */
            min-height: 400px;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.9rem;
            color: #666;
            margin-top: auto;
        }

        /* Media Queries para pantallas más grandes */
        @media (min-width: 768px) {
            header h1 {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: row;
                justify-content: space-between;
            }

            .control-group {
                flex-direction: row;
                gap: 1rem;
                width: auto;
            }

            .control-group label {
                margin-bottom: 0;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Balance Nacional de Energía de México</h1>
            <p>Una visualización interactiva del flujo de energía en México, desde la producción y la importación hasta
                el consumo final. Selecciona un año para explorar los datos.</p>
        </header>

        <div class="card">
            <div class="controls">
                <div class="control-group">
                    <label for="year-selector">Seleccionar Año:</label>
                    <select id="year-selector"></select>
                </div>
                <div class="control-group">
                    <label for="search-input">Buscar Energético:</label>
                    <input type="text" id="search-input" list="node-list" placeholder="Escribe para buscar...">
                    <datalist id="node-list"></datalist>
                </div>
                <div class="buttons">
                    <button id="descargar-png" class="btn">Descargar PNG</button>
                    <button id="descargar-svg" class="btn">Descargar SVG</button>
                    <button id="reset-view" class="btn">Restablecer Vista</button>
                </div>
            </div>
        </div>

        <div id="chart-container" class="card">
            <div id="sankey"></div>
        </div>

        <footer>
            <p>Fuente de datos: Secretaría de Energía (SENER).</p>
        </footer>
    </div>
    <script src="datos.js"></script>
    <script src="sankey_config.js"></script>
    <script src="data_processor.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chartDom = document.getElementById('sankey');
            const sankeyChart = echarts.init(chartDom, null, { renderer: 'svg' });
            const yearSelector = document.getElementById('year-selector');
            const searchInput = document.getElementById('search-input');
            const nodeDatalist = document.getElementById('node-list');

            let energyData = window.energyData;
            let allNodes = new Map(); // Para guardar la info completa de los nodos

            function updateChart(year) {
                if (!energyData) return;

                const { nodes, links } = window.dataProcessor.processSankeyData(energyData, year, window.sankeyConfig);

                // Guardar nodos para tooltip y búsqueda
                allNodes.clear();
                nodes.forEach(node => {
                    if (!node.esEspaciador) {
                        allNodes.set(node.name, node);
                    }
                });

                if (links.length === 0) {
                    sankeyChart.clear();
                    sankeyChart.showLoading({ text: `No hay datos de flujo para el año ${year}.`});
                    return;
                }
                sankeyChart.hideLoading();

                const option = {
                    title: {
                        text: `Flujo de Energía en México - ${year}`,
                        subtext: 'Valores en Petajoules (PJ)',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove',
                        formatter: function (params) {
                            if (params.name && params.name.startsWith('SPACER')) return '';
                            const formatNumber = (num) => num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' PJ';

                            if (params.dataType === 'edge') {
                                return `${params.data.source} → ${params.data.target}: ${formatNumber(params.value)}`;
                            }

                            const nodeInfo = allNodes.get(params.name);
                            let tooltipText = `<b>${params.name}</b><br/>`;

                            if (nodeInfo) {
                                const nodeColor = nodeInfo.itemStyle && nodeInfo.itemStyle.color ? nodeInfo.itemStyle.color : '#888';
                                const balance = nodeInfo.inflow - nodeInfo.outflow;

                                if (nodeInfo.flow === 'source') {
                                    tooltipText += `Salida: ${formatNumber(nodeInfo.outflow)}`;
                                } else if (nodeInfo.flow === 'sink') {
                                    tooltipText += `Entrada: ${formatNumber(nodeInfo.inflow)}`;
                                } else { // Default or intermediate node
                                    tooltipText += `Entrada: ${formatNumber(nodeInfo.inflow)}<br/>`;
                                    tooltipText += `Salida: ${formatNumber(nodeInfo.outflow)}<br/>`;
                                    tooltipText += `<span style="color:${nodeColor}; font-weight:bold;">Balance: ${formatNumber(balance)}</span>`;
                                }
                            } else {
                                tooltipText += `Total: ${formatNumber(params.value)}`;
                            }

                            if (nodeInfo && nodeInfo.description) {
                                tooltipText += `<br/><hr style="margin: 5px 0;"/><i>${nodeInfo.description}</i>`;
                            }
                            return tooltipText;
                        },
                        extraCssText: 'max-width:400px; white-space: normal;'
                    },
                    series: [{
                        type: 'sankey',
                        data: nodes,
                        links: links,
                        emphasis: { focus: 'adjacency' },
                        nodeAlign: window.sankeyConfig.layoutConfig.nodeAlign,
                        nodeGap: window.sankeyConfig.layoutConfig.nodeGap,
                        nodeWidth: window.sankeyConfig.layoutConfig.nodeWidth,
                        layoutIterations: window.sankeyConfig.layoutConfig.layoutIterations,
                        lineStyle: {
                            curveness: window.sankeyConfig.layoutConfig.curveness
                        }
                    }]
                };
                sankeyChart.setOption(option, true);
            }

            function populateDatalist() {
                const nodeNames = new Set();
                energyData.Datos.forEach(padre => {
                    nodeNames.add(padre["Nodo Padre"]);
                    padre["Nodos Hijo"].forEach(hijo => nodeNames.add(hijo["Nodo Hijo"]));
                });
                nodeDatalist.innerHTML = '';
                Array.from(nodeNames).sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    nodeDatalist.appendChild(option);
                });
            }

            function handleSearch() {
                const searchTerm = searchInput.value;
                sankeyChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
                if (searchTerm) {
                    sankeyChart.dispatchAction({ type: 'highlight', seriesIndex: 0, name: searchTerm });
                }
            }

            // --- Inicialización ---
            const years = Object.keys(energyData.Datos[0]["Nodos Hijo"][0])
                .filter(key => !isNaN(key) && key.length === 4)
                .sort((a, b) => b - a);

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });

            yearSelector.value = years[0];
            updateChart(years[0]);
            populateDatalist();

            yearSelector.addEventListener('change', (e) => updateChart(e.target.value));
            searchInput.addEventListener('input', handleSearch);

            document.getElementById('descargar-png').onclick = function () {
                const url = sankeyChart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: '#fff' });
                const a = document.createElement('a');
                a.href = url;
                a.download = `sankey_energia_mexico_${yearSelector.value}.png`;
                a.click();
            };

            document.getElementById('descargar-svg').onclick = function () {
                const url = sankeyChart.getDataURL({ type: 'svg', backgroundColor: '#fff' });
                const a = document.createElement('a');
                a.href = url;
                a.download = `sankey_energia_mexico_${yearSelector.value}.svg`;
                a.click();
            };

            window.addEventListener('resize', () => sankeyChart.resize());
        });
    </script>

</body>

</html>