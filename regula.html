<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Normativo Georreferenciado — MVP</title>

<!-- Leaflet y MarkerCluster desde CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --panel:#0b1222;     /* deep blue */
    --card:#111827;      /* gray-900 */
    --muted:#94a3b8;     /* slate-400 */
    --text:#e5e7eb;      /* gray-200 */
    --accent:#22d3ee;    /* cyan-400 */
    --good:#22c55e;      /* green-500 */
    --warn:#f59e0b;      /* amber-500 */
    --risk:#ef4444;      /* red-500 */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0b1222, #0f172a);
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  }
  header{
    position:sticky; top:0; z-index:1000; backdrop-filter: blur(10px);
    background:rgba(17,24,39,.6); border-bottom:1px solid rgba(255,255,255,.06);
    padding:12px 18px; display:flex; align-items:center; gap:12px;
  }
  header .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 14px var(--accent)}
  header h1{font-size:16px; margin:0; font-weight:600; letter-spacing:.2px}
  .wrap{display:grid; grid-template-columns:320px 1fr; min-height:calc(100vh - 58px);}
  @media (max-width: 1024px){ .wrap{grid-template-columns:1fr} #sidebar{order:2; height:auto} #map{height:60vh}}
  #sidebar{
    padding:16px; border-right:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  }
  .kpis{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:14px}
  .card{
    background:radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px 14px;
    box-shadow: 0 8px 30px rgba(0,0,0,.25);
  }
  .card h3{font-size:12px; font-weight:500; color:var(--muted); margin:0 0 4px}
  .card .big{font-size:22px; font-weight:700}
  .filters{display:grid; gap:10px; margin:10px 0 16px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  select,input[type="date"],input[type="range"]{
    width:100%; background:#0a0f1a; color:var(--text);
    border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px;
    outline:none;
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    background:linear-gradient(180deg, rgba(34,211,238,.2), rgba(34,211,238,.05));
    border:1px solid rgba(34,211,238,.5); color:var(--accent);
    border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:600;
    transition: all .2s ease; text-decoration:none;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(34,211,238,.25)}
  #map{height:calc(100vh - 58px); width:100%}
  .legend{
    position:absolute; bottom:14px; left:14px; z-index:500;
    background:rgba(17,24,39,.7); color:var(--text);
    padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    font-size:12px;
  }
  .legend .row{display:flex; align-items:center; gap:8px; margin-top:6px}
  .sw{width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.2)}
  .loader{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:800;
    background:rgba(10,15,26,.35); backdrop-filter: blur(2px);
  }
  .loader.show{display:flex}
  .badg{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.18)}
  .b-good{background:rgba(34,197,94,.15); color:#86efac}
  .b-warn{background:rgba(245,158,11,.15); color:#fde68a}
  .b-risk{background:rgba(239,68,68,.15); color:#fecaca}
</style>
</head>
<body>
<header>
  <div class="dot"></div>
  <h1>Dashboard Normativo Georreferenciado — MVP (HTML+CSS+JS)</h1>
</header>

<div class="wrap">
  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="kpis">
      <div class="card"><h3>Total entidades</h3><div class="big" id="kpi-total">—</div></div>
      <div class="card"><h3>Promedio cumplimiento</h3><div class="big" id="kpi-cumpl">— %</div></div>
      <div class="card"><h3>Hallazgos abiertos</h3><div class="big" id="kpi-open">—</div></div>
    </div>

    <div class="card">
      <h3>Filtros</h3>
      <div class="filters">
        <div>
          <label for="f-sector">Sector</label>
          <select id="f-sector">
            <option value="">Todos</option>
            <option>Eléctrico</option>
            <option>Hidrocarburos</option>
            <option>Industrial</option>
            <option>Servicios</option>
          </select>
        </div>
        <div>
          <label for="f-estatus">Estatus</label>
          <select id="f-estatus">
            <option value="">Todos</option>
            <option>Vigente</option>
            <option>En proceso</option>
            <option>No vigente</option>
          </select>
        </div>
        <div>
          <label for="f-riesgo">Riesgo</label>
          <select id="f-riesgo">
            <option value="">Todos</option>
            <option>Bajo</option>
            <option>Medio</option>
            <option>Alto</option>
          </select>
        </div>
        <div>
          <label>Rango de fechas (evaluación)</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
            <input type="date" id="f-desde" />
            <input type="date" id="f-hasta" />
          </div>
        </div>
        <div>
          <label for="f-cumpl">Mín. cumplimiento: <span id="lbl-cumpl">0%</span></label>
          <input type="range" id="f-cumpl" min="0" max="100" value="0" />
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="btn-aplicar">Aplicar filtros</button>
          <button class="btn" id="btn-reset">Limpiar</button>
          <button class="btn" id="btn-export">Exportar CSV</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Notas</h3>
      <p style="color:var(--muted); font-size:13px">
        • Para activar la coroplética real, apunta la variable <code>GEOJSON_URL</code> a tu GeoJSON de estados o municipios.<br>
        • Reemplaza el arreglo <code>POINTS</code> por tus instalaciones / centros regulados.
      </p>
    </div>
  </aside>

  <!-- MAPA -->
  <main style="position:relative">
    <div id="map"></div>
    <div class="legend" id="legend">
      <div><strong>Cumplimiento (%)</strong></div>
      <div class="row"><span class="sw" style="background:#22c55e"></span><span>≥ 80</span></div>
      <div class="row"><span class="sw" style="background:#f59e0b"></span><span>60–79</span></div>
      <div class="row"><span class="sw" style="background:#e67e22"></span><span>40–59</span></div>
      <div class="row"><span class="sw" style="background:#ef4444"></span><span>&lt; 40</span></div>
    </div>
    <div class="loader" id="loader"><div class="card">Cargando datos…</div></div>
  </main>
</div>

<script>
/* =======================
   1) CONFIGURACIÓN
======================= */

// 1.1 GeoJSON (cuando lo tengas, cambia esta URL)
const GEOJSON_URL = ""; // Ej.: "/data/mx_estados.geojson" (con propiedades: cve_ent, nombre)

// 1.2 Datos de cumplimiento por entidad (demo). Clave = código entidad (o municipio)
// Su estructura debe alinearse con tu GeoJSON (por ejemplo, "cve_ent" para estados)
const CUMPLIMIENTO_POR_ENTIDAD = {
  // "09": { nombre:"Ciudad de México", cumplimiento: 85, pendientes: 12 },
  // "15": { nombre:"Estado de México", cumplimiento: 62, pendientes: 33 },
};

// 1.3 Puntos (instalaciones) DEMO — reemplázalos por tus datos reales
let POINTS = [
  {
    id:"LX-001", razon_social:"Planta Norte", sector:"Eléctrico",
    estatus:"Vigente", riesgo:"Bajo", cumplimiento:92,
    lat: 25.6866, lng:-100.3161, // Monterrey
    fecha_eval:"2025-07-12",
    url_ficha:"#"
  },
  {
    id:"LX-002", razon_social:"Terminal Golfo", sector:"Hidrocarburos",
    estatus:"En proceso", riesgo:"Medio", cumplimiento:68,
    lat: 19.4326, lng:-99.1332,  // CDMX
    fecha_eval:"2025-06-02",
    url_ficha:"#"
  },
  {
    id:"LX-003", razon_social:"Parque Industrial Delta", sector:"Industrial",
    estatus:"No vigente", riesgo:"Alto", cumplimiento:38,
    lat: 20.9671, lng:-89.5926,  // Mérida
    fecha_eval:"2025-05-20",
    url_ficha:"#"
  },
  {
    id:"LX-004", razon_social:"Centro Servicios Pacífico", sector:"Servicios",
    estatus:"Vigente", riesgo:"Medio", cumplimiento:74,
    lat: 32.5149, lng:-117.0382, // Tijuana
    fecha_eval:"2025-08-01",
    url_ficha:"#"
  }
];

/* =======================
   2) MAPA
======================= */
const map = L.map('map', { zoomControl: true }).setView([23.6,-102.5], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const loader = document.getElementById('loader');

// Marker cluster
const cluster = L.markerClusterGroup({ chunkedLoading: true });
let pointLayers = []; // para refrescar

// Coroplética
let geoLayer = null;

function colorPorCumpl(v){
  if (v >= 80) return '#22c55e';
  if (v >= 60) return '#f59e0b';
  if (v >= 40) return '#e67e22';
  return '#ef4444';
}

function estiloEntidad(f){
  const key = f.properties.cve_ent || f.properties.cvegeo || f.properties.cve || f.properties.CVE_ENT;
  const item = key ? CUMPLIMIENTO_POR_ENTIDAD[String(key)] : null;
  const v = item ? Number(item.cumplimiento) : null;
  return {
    fillOpacity: v!=null ? 0.65 : 0.15,
    weight: 1,
    color: 'rgba(255,255,255,.6)',
    fillColor: v!=null ? colorPorCumpl(v) : 'rgba(255,255,255,.12)'
  }
}

function bindEntidad(f, layer){
  const key = f.properties.cve_ent || f.properties.cvegeo || f.properties.cve || f.properties.CVE_ENT;
  const item = key ? CUMPLIMIENTO_POR_ENTIDAD[String(key)] : null;
  const nombre = (item && item.nombre) || f.properties.nombre || f.properties.NOM_ENT || 'Entidad';
  const v = item ? item.cumplimiento : '—';
  const p = item ? item.pendientes : '—';
  layer.bindPopup(`<b>${nombre}</b><br>Cumplimiento: <b>${v}%</b><br>Pendientes: <b>${p}</b>`);
}

async function cargarGeo(){
  if(!GEOJSON_URL){ return; } // opcional: sin geojson no pintamos coroplética
  try{
    loader.classList.add('show');
    const res = await fetch(GEOJSON_URL);
    const gj = await res.json();
    if (geoLayer) { map.removeLayer(geoLayer); }
    geoLayer = L.geoJSON(gj, {
      style: estiloEntidad,
      onEachFeature: bindEntidad
    }).addTo(map);
    try { map.fitBounds(geoLayer.getBounds(), {padding:[10,10]}); } catch(e){}
  }catch(err){
    console.error('Error cargando GeoJSON:', err);
  }finally{
    loader.classList.remove('show');
  }
}

function iconByRisk(r){
  if (r==="Alto") return '🔴';
  if (r==="Medio") return '🟠';
  return '🟢';
}

function pintarPuntos(datos){
  cluster.clearLayers();
  pointLayers = datos.map(d=>{
    const m = L.marker([d.lat,d.lng], { title: d.razon_social });
    const badge = d.riesgo==="Alto" ? 'badg b-risk' : d.riesgo==="Medio" ? 'badg b-warn' : 'badg b-good';
    m.bindPopup(`
      <div style="min-width:240px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><b>${d.razon_social}</b><br><small>${d.sector}</small></div>
          <div class="${badge}">${d.riesgo}</div>
        </div>
        <div style="margin-top:6px">
          Estatus: <b>${d.estatus}</b><br>
          Cumplimiento: <b>${d.cumplimiento}%</b><br>
          Evaluación: <b>${d.fecha_eval}</b>
        </div>
        <div style="margin-top:8px">
          <a href="${d.url_ficha}" class="btn" target="_blank" rel="noopener">Abrir ficha</a>
        </div>
      </div>
    `);
    return m;
  });
  pointLayers.forEach(m=>cluster.addLayer(m));
  map.addLayer(cluster);
}

/* =======================
   3) FILTROS + KPIs
======================= */
const $ = sel => document.querySelector(sel);
const fSector = $('#f-sector');
const fEstatus = $('#f-estatus');
const fRiesgo = $('#f-riesgo');
const fDesde = $('#f-desde');
const fHasta = $('#f-hasta');
const fCumpl = $('#f-cumpl');
const lblCumpl = $('#lbl-cumpl');

function aplicarFiltros(){
  const sector = fSector.value;
  const estatus = fEstatus.value;
  const riesgo = fRiesgo.value;
  const desde = fDesde.value ? new Date(fDesde.value) : null;
  const hasta = fHasta.value ? new Date(fHasta.value) : null;
  const minCumpl = Number(fCumpl.value)||0;

  const filtrados = POINTS.filter(p=>{
    if (sector && p.sector!==sector) return false;
    if (estatus && p.estatus!==estatus) return false;
    if (riesgo && p.riesgo!==riesgo) return false;
    if (p.cumplimiento < minCumpl) return false;
    if (desde || hasta){
      const d = new Date(p.fecha_eval);
      if (desde && d < desde) return false;
      if (hasta && d > hasta) return false;
    }
    return true;
  });

  pintarPuntos(filtrados);
  actualizarKPIs(filtrados);
}

function promedio(arr, key){
  if (!arr.length) return 0;
  const s = arr.reduce((a,b)=>a + (Number(b[key])||0), 0);
  return Math.round((s/arr.length)*10)/10;
}

function actualizarKPIs(data){
  $('#kpi-total').textContent = String(data.length);
  $('#kpi-cumpl').textContent = data.length ? (promedio(data,'cumplimiento') + ' %') : '— %';
  // “hallazgos abiertos” como demo: sumamos 1 si estatus ≠ Vigente
  const abiertos = data.reduce((acc,p)=> acc + (p.estatus==="Vigente" ? 0 : 1), 0);
  $('#kpi-open').textContent = String(abiertos);
}

// Exportación CSV básica
function exportCSV(data){
  const headers = ['id','razon_social','sector','estatus','riesgo','cumplimiento','lat','lng','fecha_eval','url_ficha'];
  const rows = [headers.join(',')];
  data.forEach(d=>{
    const row = headers.map(h=>{
      const v = (d[h] != null) ? String(d[h]).replace(/,/g,';') : '';
      return `"${v}"`;
    }).join(',');
    rows.push(row);
  });
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'dashboard_normativo.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =======================
   4) EVENTOS
======================= */
$('#btn-aplicar').addEventListener('click', aplicarFiltros);
$('#btn-reset').addEventListener('click', ()=>{
  [fSector,fEstatus,fRiesgo].forEach(e=>e.value="");
  fDesde.value=""; fHasta.value="";
  fCumpl.value = 0; lblCumpl.textContent = "0%";
  pintarPuntos(POINTS);
  actualizarKPIs(POINTS);
});
$('#btn-export').addEventListener('click', ()=>{
  // exportamos lo que está pintado actualmente (cluster -> pointLayers)
  const idsVisibles = new Set(pointLayers.map((m)=>m.options.title));
  const data = POINTS.filter(p=> idsVisibles.has(p.razon_social));
  exportCSV(data);
});
fCumpl.addEventListener('input', ()=>{ lblCumpl.textContent = fCumpl.value + '%'; });

/* =======================
   5) INICIALIZACIÓN
======================= */
(async function init(){
  pintarPuntos(POINTS);
  actualizarKPIs(POINTS);
  if (GEOJSON_URL) await cargarGeo();
})();
</script>
</body>
</html>
